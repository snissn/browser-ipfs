<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Helia IPFS Temporary Pinning</title>
    <script src="https://cdn.jsdelivr.net/npm/helia@5.2.1/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@helia/unixfs@latest/dist/index.min.js"></script>
  </head>
  <body>
    <h2>Helia IPFS Temporary Pinning</h2>
    <input type="file" id="fileInput" />
    <button onclick="addFile()">Add File</button>
    <button onclick="retrieveFile()">Retrieve File</button>
    <p id="output"></p>

    <script>
      let helia;
      let fs;

      async function initHelia() {
        try {
          helia = await heliaBrowser.createHelia(); // Using the global object exposed by the script
          fs = unixfs.unixfs(helia);
          console.log("Helia node initialized.");
        } catch (err) {
          console.error("Failed to initialize Helia:", err);
        }
      }

      window.addFile = async function () {
        if (!helia) {
          alert("Helia is not initialized.");
          return;
        }

        const fileInput = document.getElementById("fileInput");
        if (!fileInput.files.length) {
          alert("Please select a file first.");
          return;
        }

        const file = fileInput.files[0];
        const fileBuffer = await file.arrayBuffer();
        const cid = await fs.addFile({
          path: file.name,
          content: new Uint8Array(fileBuffer),
        });

        console.log("Added file CID:", cid.toString());
        localStorage.setItem("lastCID", cid.toString());

        document.getElementById("output").innerHTML =
          `File added: <b>${cid.toString()}</b>`;
      };

      window.retrieveFile = async function () {
        if (!helia) {
          alert("Helia is not initialized.");
          return;
        }

        const lastCID = localStorage.getItem("lastCID");
        if (!lastCID) {
          alert("No CID found in storage.");
          return;
        }

        try {
          const fileData = [];
          for await (const chunk of fs.cat(lastCID)) {
            fileData.push(...chunk);
          }

          const blob = new Blob([new Uint8Array(fileData)], {
            type: "application/octet-stream",
          });
          const url = URL.createObjectURL(blob);

          document.getElementById("output").innerHTML =
            `Retrieved file: <a href="${url}" download="retrieved_file">Download</a>`;
        } catch (err) {
          console.error("Error retrieving file:", err);
          alert("Failed to retrieve file.");
        }
      };

      window.onload = initHelia;
    </script>
  </body>
</html>
