<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Helia IPFS Pinning</title>
    <script type="module">
      import { createHelia } from "https://cdn.skypack.dev/helia@latest";
      import { unixfs } from "https://cdn.skypack.dev/@helia/unixfs@latest";

      let helia;
      let fs;

      async function initHelia() {
        helia = await createHelia();
        fs = unixfs(helia);
        console.log("Helia node initialized.");
      }

      async function addFile() {
        const fileInput = document.getElementById("fileInput");
        if (!fileInput.files.length) {
          alert("Please select a file first.");
          return;
        }

        const file = fileInput.files[0];
        const fileBuffer = await file.arrayBuffer();
        const cid = await fs.addFile({
          path: file.name,
          content: new Uint8Array(fileBuffer),
        });

        console.log("Added file CID:", cid.toString());
        localStorage.setItem("lastCID", cid.toString());

        document.getElementById("output").innerHTML =
          `File added: <b>${cid.toString()}</b>`;
      }

      async function retrieveFile() {
        const lastCID = localStorage.getItem("lastCID");
        if (!lastCID) {
          alert("No CID found in storage.");
          return;
        }

        const fileData = [];
        for await (const chunk of fs.cat(lastCID)) {
          fileData.push(...chunk);
        }

        const blob = new Blob([new Uint8Array(fileData)], {
          type: "application/octet-stream",
        });
        const url = URL.createObjectURL(blob);

        document.getElementById("output").innerHTML =
          `Retrieved file: <a href="${url}" download="retrieved_file">Download</a>`;
      }

      window.onload = initHelia;
    </script>
  </head>
  <body>
    <h2>Helia IPFS Temporary Pinning</h2>
    <input type="file" id="fileInput" />
    <button onclick="addFile()">Add File</button>
    <button onclick="retrieveFile()">Retrieve File</button>
    <p id="output"></p>
  </body>
</html>
